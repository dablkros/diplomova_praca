<!doctype html>
<html lang="sk">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>NETCONF Web Panel</title>

    <!-- =======================
         ŠTÝLY
         ======================= -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 2rem;
        }

        input, button, select {
            margin: 0.5rem 0;
            width: 100%;
            padding: 0.5rem;
            box-sizing: border-box;
        }

        /* Hlásenia (success/error/info) */
        #message {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: 5px;
            display: none;
            white-space: pre-wrap;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .info {
            background: #e2e3e5;
            color: #383d41;
            border: 1px solid #d6d8db;
        }

        /* Grid tlačidlá */
        .button-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .button-grid button {
            width: 100%;
        }

        /* ============ MODAL ============ */
        .modal {
            position: fixed;
            inset: 0; /* top/left/right/bottom:0 */
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #fff;
            padding: 1rem;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            position: relative;
        }

        /* krížik */
        .close {
            position: absolute;
            top: 0.5rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            user-select: none;
        }

        /* Stop tlačidlo v modal okne (pri grafe) */
        .stop-button {
            position: absolute;
            top: 0.5rem;
            right: 2.5rem; /* vedľa krížika */
            background: #f5f5f5;
            border: 1px solid #ccc;
            color: #333;
            padding: 0.25rem 0.75rem;
            font-size: 0.9rem;
            border-radius: 4px;
            cursor: pointer;
            width: auto;
            min-width: 4rem;
        }

        .stop-button:hover {
            background: #e0e0e0;
        }

        /* Panel Live counters */
        #liveCounter {
            display: none;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 1rem;
        }

        /* Diff output */
        #diffOutput {
            white-space: pre-wrap;
            background: #111;
            color: #eee;
            padding: 1rem;
            border-radius: 6px;
            max-height: 350px;
            overflow: auto;
        }
    </style>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
</head>

<body>
<h2>NETCONF Ovládací Panel</h2>

<!-- =======================
     KASKÁDOVÝ VÝBER (NetBox)
     ======================= -->
<label for="regionSelect">Vyber región:</label>
<select id="regionSelect">
    <option value="">-- Vyber --</option>
</select>

<label for="subregionSelect">Vyber subregión:</label>
<select id="subregionSelect">
    <option value="">-- Vyber --</option>
</select>

<label for="siteSelect">Vyber site:</label>
<select id="siteSelect">
    <option value="">-- Vyber --</option>
</select>

<label for="deviceSelect">Vyber zariadenie:</label>
<select id="deviceSelect">
    <option value="">-- Vyber --</option>
</select>

<!-- =======================
     PRIHLASOVACIE ÚDAJE (NETCONF)
     ======================= -->
<input type="text" id="host" placeholder="IP zariadenia (host)">
<input type="text" id="username" placeholder="Používateľské meno">
<input type="password" id="password" placeholder="Heslo">

<label for="interfaceSelect">Vyber interface zariadenia:</label>
<select id="interfaceSelect">
    <option value="">-- Vyber --</option>
</select>

<!-- voliteľné pole pre DHCP akciu -->
<input type="text" id="ip_address" placeholder="IP adresa pre DHCP (voliteľné)">

<!-- =======================
     OVLÁDACIE TLAČIDLÁ
     ======================= -->
<div class="button-grid">
    <button data-action="shutdown">Vypnúť interface</button>
    <button data-action="no-shutdown">Zapnúť interface</button>
    <button data-action="restart-interface">Reštartovať interface</button>
    <button disabled>PlaceHolder</button>
    <button data-action="check_macaddress">Zobraz MAC adresu</button>
    <button id="clearMacBtn">Vymazať MAC tabuľku (dynamic)</button>

    <button data-action="clear-counters">Resetovanie counterov</button>
    <button data-action="show-counters">Zobraz packet counters</button>

    <button data-action="show-status-int">Stav interface</button>

    <button data-action="show-dhcp-bindings">Zobraz DHCP bindingy</button>
    <button data-action="clear-dhcp-binding">Vymazať DHCP binding</button>

    <button data-action="configure-interface">Konfiguruj interface</button>

    <button id="compareConfigBtn">Porovnať port (config diff)</button>
    <button onclick="applyReplace()">Aplikovať REPLACE (SoT)</button>

    <button id="measureBtn">Štart error graf</button>
    <button id="liveBtn">Live counter</button>

    <button disabled>Akcia 7</button>
</div>

<!-- Live counters panel -->
<div id="liveCounter">
    <strong>Live counters:</strong><br>
    Input packets: <span id="liveInput">0</span><br>
    Output packets: <span id="liveOutput">0</span><br>
    <button id="stopLiveBtn" style="margin-top:0.5rem;">■ Stop live</button>
</div>

<!-- Hlásenia -->
<div id="message"></div>

<!-- =======================
     MODAL: GRAF ERROR COUNTERS
     ======================= -->
<div id="chartModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <span id="closeChartModal" class="close" title="Zavrieť">&times;</span>
        <button id="stopModalBtn" class="stop-button">■ Stop</button>
        <h3>Packet Error Counters (real-time)</h3>
        <canvas id="modalCountersChart" style="width:100%; height:300px;"></canvas>
    </div>
</div>

<!-- =======================
     MODAL: DIFF (Device vs NetBox SoT)
     ======================= -->
<div id="diffModal" class="modal" aria-hidden="true">
    <div class="modal-content">
        <span id="closeDiffModal" class="close" title="Zavrieť">&times;</span>
        <h3>Diff portu (Device vs NetBox SoT)</h3>

        <div style="margin:0.5rem 0; display:flex; gap:0.5rem;">
            <button id="diffApplyMergeBtn">Aplikovať (merge)</button>
            <button id="diffApplyReplaceBtn">Aplikovať (replace)</button>
        </div>

        <div id="diffSummary" class="info" style="padding:0.75rem; border-radius:6px; display:none;"></div>
        <pre id="diffOutput"></pre>
    </div>
</div>

<!-- =======================
     SKRIPT (logika aplikácie)
     ======================= -->
<script>
    /******************************************************************
     * KONŠTANTY / KONFIG
     ******************************************************************/
    const API_BASE = "http://localhost:8001"; // Backend (FastAPI/...)
    const WS_HOST = () => `ws://${location.hostname}:8001`; // WebSocket base

    /******************************************************************
     * DOM HELPERY
     ******************************************************************/
    const $ = (id) => document.getElementById(id);

    function openModal(id) {
        $(id).style.display = "flex";
    }

    function closeModal(id) {
        $(id).style.display = "none";
    }


    function showMessage(text, type = "info") {
        const box = $("message");
        if (!text) {
            box.style.display = "none";
            box.textContent = "";
            box.className = "";
            return;
        }
        box.style.display = "block";
        box.className = type; // success / error / info
        box.textContent = text;
    }

    function clearSelect(selectId) {
        $(selectId).innerHTML = `<option value="">-- Vyber --</option>`;
    }

    /**
     * Naplní <select> options z dát.
     * @param {string} selectId - id selectu
     * @param {Array} data - pole objektov
     * @param {string} labelKey - kľúč pre text
     * @param {string} valueKey - kľúč pre value
     * @param {string|null} extraKey - uloží do dataset (napr. ip)
     */
    function fillSelect(selectId, data, labelKey, valueKey, extraKey = null) {
        const sel = $(selectId);
        data.forEach(item => {
            const opt = document.createElement("option");
            opt.value = item[valueKey];
            opt.textContent = item[labelKey];
            if (extraKey && item[extraKey]) opt.dataset[extraKey] = item[extraKey];
            sel.appendChild(opt);
        });
    }

    /******************************************************************
     * API WRAPPER (fetch)
     ******************************************************************/
    async function apiGet(path) {
        const resp = await fetch(`${API_BASE}${path}`);
        if (!resp.ok) throw new Error(`GET ${path} zlyhalo (${resp.status})`);
        return resp.json();
    }

    async function apiPost(path, body) {
        const resp = await fetch(`${API_BASE}${path}`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(body)
        });
        const json = await resp.json().catch(() => ({}));
        if (!resp.ok || json.detail) {
            throw new Error(json.detail || `POST ${path} zlyhalo (${resp.status})`);
        }
        return json;
    }

    /******************************************************************
     * NETBOX FETCH FUNKCIE
     ******************************************************************/
    const fetchRegions = () => apiGet("/regions");
    const fetchSubregions = (regionId) => regionId ? apiGet(`/regions/${regionId}/subregions`) : Promise.resolve([]);
    const fetchSitesByRegion = (regionId) =>
        apiGet(regionId ? `/sites?region_id=${encodeURIComponent(regionId)}` : "/sites");

    const fetchDevicesBySite = (siteId) =>
        apiGet(siteId ? `/devices/filter?site_id=${encodeURIComponent(siteId)}` : "/devices/filter");

    const fetchInterfaces = (deviceName) =>
        apiGet(`/interfaces?device_name=${encodeURIComponent(deviceName)}`);

    /******************************************************************
     * KASKÁDOVÉ SELECTY (region -> subregion -> site -> device -> iface)
     ******************************************************************/
    async function onRegionChange() {
        const regionId = $("regionSelect").value;

        clearSelect("subregionSelect");
        clearSelect("siteSelect");
        clearSelect("deviceSelect");
        clearSelect("interfaceSelect");

        if (!regionId) return;

        try {
            showMessage("Načítavam subregióny…", "info");
            const subregions = await fetchSubregions(regionId);
            fillSelect("subregionSelect", subregions, "name", "id");
            showMessage("", "info");
        } catch (e) {
            showMessage(e.message, "error");
        }
    }

    async function onSubregionChange() {
        const subregionId = $("subregionSelect").value;

        clearSelect("siteSelect");
        clearSelect("deviceSelect");
        clearSelect("interfaceSelect");

        if (!subregionId) return;

        try {
            showMessage("Načítavam site-y…", "info");
            const sites = await fetchSitesByRegion(subregionId);
            fillSelect("siteSelect", sites, "name", "id");
            showMessage("", "info");
        } catch (e) {
            showMessage(e.message, "error");
        }
    }

    async function onSiteChange() {
        const siteId = $("siteSelect").value;

        clearSelect("deviceSelect");
        clearSelect("interfaceSelect");

        if (!siteId) return;

        try {
            showMessage("Načítavam zariadenia…", "info");
            const devices = await fetchDevicesBySite(siteId);
            // devices: {name, ip, ...}
            const sel = $("deviceSelect");
            devices.forEach(d => {
                const opt = document.createElement("option");
                opt.value = d.name;
                opt.textContent = d.name;
                if (d.ip) opt.dataset.ip = d.ip;
                sel.appendChild(opt);
            });
            showMessage("", "info");
        } catch (e) {
            showMessage(e.message, "error");
        }
    }

    function escapeHtml(str) {
        return (str || "")
            .replaceAll("&", "&amp;")
            .replaceAll("<", "&lt;")
            .replaceAll(">", "&gt;");
    }

    function renderDiff(diffLines) {
        // unified diff: --- +++ @@, - removed, + added, " " context
        return (diffLines || []).map(line => {
            const safe = escapeHtml(line);

            if (line.startsWith('---') || line.startsWith('+++') || line.startsWith('@@')) {
                return `<div><strong>${safe}</strong></div>`;
            }
            if (line.startsWith('+')) {
                return `<div style="color: #0a7a0a;">${safe}</div>`;
            }
            if (line.startsWith('-')) {
                return `<div style="color: #b00020;">${safe}</div>`;
            }
            return `<div>${safe}</div>`;
        }).join("");
    }

    async function compareConfigUI() {
        const deviceName = $("deviceSelect").value;
        const host = $("host").value;
        const iface = $("interfaceSelect").value;

        if (!deviceName || !host || !iface) {
            return showMessage("Vyber zariadenie, host a rozhranie.", "error");
        }

        // creds posielaj len keď sú vyplnené (aby si neprebíjala .env)
        const u = $("username").value.trim();
        const p = $("password").value;

        const payload = {
            device_name: deviceName,
            host: host,
            interface: iface
        };
        if (u) payload.username = u;
        if (p) payload.password = p;

        showMessage("Porovnávam SoT vs device…", "info");

        try {
            const res = await apiPost("/interface/compare-config", payload);

            const status = res.in_sync ? "IN SYNC ✅" : "OUT OF SYNC ⚠️";

// diffLines deklaruj iba raz
            const diffLines = (res.config && res.config.diff) ? res.config.diff : (res.diff || []);

            const diffCount = diffLines.filter(l =>
                (l.startsWith("+") && !l.startsWith("+++")) ||
                (l.startsWith("-") && !l.startsWith("---"))
            ).length;

            $("diffOutput").innerHTML = renderDiff(diffLines);

// (tu si potom nastav summary text)
            $("diffSummary").style.display = "block";
            $("diffSummary").textContent =
                `Device: ${res.device} Platform: ${res.platform} Interface: ${res.interface} ` +
                `Status: ${status}  Rozdiely: ${diffCount}`;

            openModal("diffModal");


// a message box schovaj
            showMessage("", "info");
        } catch (e) {
            showMessage(`Chyba: ${e.message}`, "error");
        }
    }


    async function clearMacTableUI() {
        const deviceSelect = $("deviceSelect");
        const deviceName = deviceSelect.value;

        // host už vyplňuješ automaticky z deviceSelect.dataset.ip v onDeviceChange
        const host = $("host").value;

        if (!deviceName || !host) {
            return showMessage("Vyber zariadenie a skontroluj, či sa vyplnila IP (host).", "error");
        }

        // Bezpečný default: interface scope (ak je vybraný interface), inak global
        const iface = $("interfaceSelect").value;

        const payload = {
            device_name: deviceName,
            host: host,
            // username/password posielaj len ak ich chceš override-núť:
            username: $("username").value || null,
            password: $("password").value || null,
            dynamic_only: true
        };

        // Ak chceš vymazať iba na porte, pošli interface
        // (ak interface nie je vybraný, spraví global clear)
        // 1) ak máš VLAN input (ak ešte nemáš, stačí vynechať vlanVal a nechá to iba auto-detekciu z iface)
        const vlanVal = ($("vlanInput") ? $("vlanInput").value.trim() : "");

// 2) najprv VLAN explicitne
        if (vlanVal) {
            payload.vlan = Number(vlanVal);
        } else if (iface) {
            // 3) ak niekto vyberie "Vlan 1" z interfaceSelect, premapuj to na VLAN scope
            const m = iface.match(/^\s*Vlan\s*(\d+)\s*$/i);
            if (m) {
                payload.vlan = Number(m[1]);
            } else {
                // 4) inak je to normálny port
                payload.interface = iface;
            }
        }


        showMessage("Mažem MAC tabuľku…", "info");

        try {
            const res = await apiPost("/mac-table/clear", payload);

            // pekný výstup
            const out = [
                `OK ✅`,
                `Device: ${res.device}`,
                `Platform: ${res.platform}`,
                `Command: ${res.command}`,
                ``,
                `${res.output || ""}`
            ].join("\n");

            showMessage(out, "success");
        } catch (e) {
            showMessage(`Chyba: ${e.message}`, "error");
        }
    }

    async function onDeviceChange() {
        const select = $("deviceSelect");
        const deviceName = select.value;

        clearSelect("interfaceSelect");

        // automaticky vyplní host IP podľa vybraného device (ak je v dataset)
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption?.dataset?.ip) $("host").value = selectedOption.dataset.ip;

        if (!deviceName) return;

        try {
            showMessage("Načítavam interfejsy…", "info");
            const ifaces = await fetchInterfaces(deviceName);
            fillSelect("interfaceSelect", ifaces, "name", "name");
            showMessage("", "info");
        } catch (e) {
            showMessage(e.message, "error");
        }
    }

    /******************************************************************
     * ZOSTAVENIE PAYLOADU (spoločné pre viac akcií)
     ******************************************************************/
    function buildBasePayload() {
        const u = $("username").value.trim();
        const p = $("password").value;

        const payload = {
            device_name: $("deviceSelect").value,
            host: $("host").value,
            interface: $("interfaceSelect").value
        };

        // posielaj creds len ak sú reálne vyplnené
        if (u) payload.username = u;
        if (p) payload.password = p;

        return payload;
    }


    function buildActionPayload(action) {
        const data = buildBasePayload();
        // DHCP akcie môžu potrebovať ip_address
        const ip = $("ip_address").value;
        if (["clear-dhcp", "clear-dhcp-binding"].includes(action) && ip) {
            data.ip_address = ip;
        }
        return data;
    }

    function validateForAction(action, payload) {
        // vždy musí byť device + host
        if (!payload.device_name || !payload.host) return false;

        // tieto akcie potrebujú interface
        const needsInterface = new Set([
            "shutdown", "no-shutdown", "restart-interface",
            "check_macaddress", "clear-counters", "show-counters", "show-status-int",
            "configure-interface"
        ]);

        if (needsInterface.has(action) && !payload.interface) return false;

        // creds: ak chceš, môžeš ich vyžadovať len pre WS alebo konkrétne akcie,
        // ale pri REST ich pokojne nechaj prázdne (backend má .env)
        return true;
    }


    /******************************************************************
     * UNIVERZÁLNA AKCIA: sendRequest()
     * - volá backend endpoint /{action}
     * - podľa odpovede zobrazí formátovaný výstup
     ******************************************************************/

    async function sendRequest(action) {
        const data = buildActionPayload(action);

        if (!validateForAction(action, data)) {
            return showMessage("Vyplň aspoň device + host (a pri niektorých akciách aj interface).", "error");
        }

        showMessage("Spracováva sa požiadavka…", "info");

        try {
            const json = await apiPost(`/${action}`, data);

            // špeciálne formátovanie pre niektoré odpovede
            if (action === "check_macaddress" && Array.isArray(json.mac_adresy)) {
                if (!json.mac_adresy.length) return showMessage("Žiadne MAC adresy nenájdené.", "info");
                const html = json.mac_adresy.map(e => `${e.mac} – ${e.vendor}`).join("\n");
                showMessage(html, "success");
                return;
            }

            if (action === "show-counters" && Array.isArray(json.counters)) {
                if (!json.counters.length) return showMessage("Nenájdené žiadne packet counters.", "info");
                const lines = json.counters.map(e =>
                    `Interface ${e.INTERFACE}: Input=${e.INPUT_PACKETS}, Output=${e.OUTPUT_PACKETS}`
                ).join("\n");
                showMessage(lines, "success");
                return;
            }

            if (action === "show-status-int") {
                // nový formát: backend vracia { stav: "...", state: {...} }
                if (json.state) {
                    const s = json.state;

                    const lines =
                        `Interface ${s.interface}:\n` +
                        `Link: ${s.link ?? s.status ?? "?"}, Protocol: ${s.protocol ?? "?"}\n` +
                        `Duplex: ${s.duplex ?? "?"}, Speed: ${s.speed ?? "?"}`;

                    showMessage(lines, "success");
                    return;
                }

                // fallback (ak by backend ešte vracal staré "counters" pole)
                if (Array.isArray(json.counters) && json.counters.length) {
                    const lines = json.counters.map(e =>
                        `Interface ${e.INTERFACE}:\n` +
                        `  Link: ${e.LINK_STATUS}, Protocol: ${e.PROTOCOL_STATUS}\n` +
                        `  Duplex: ${e.DUPLEX}, Speed: ${e.SPEED}`
                    ).join("\n\n");
                    showMessage(lines, "success");
                    return;
                }

                return showMessage("Nenájdené žiadne údaje o interface.", "info");
            }

            if (action === "show-dhcp-bindings" && Array.isArray(json.bindings)) {
                if (!json.bindings.length) return showMessage("Žiadne DHCP bindingy nenájdené.", "info");
                const lines = json.bindings.map(e =>
                    `IP: ${e.IP_ADDRESS}, MAC: ${e.HARDWARE_ADDRESS}\n` +
                    `  Lease until: ${e.EXPIRATION}, Type: ${e.TYPE}`
                ).join("\n\n");
                showMessage(lines, "success");
                return;
            }

            // default
            showMessage(`Úspech: ${json.stav || "Operácia prebehla úspešne."}`, "success");
        } catch (e) {
            showMessage(`Chyba: ${e.message}`, "error");
        }
    }

    /******************************************************************
     * DIFF (SoT) LOGIKA: compare/apply
     ******************************************************************/
    function buildPortPayload() {
        return {
            device_name: document.getElementById("deviceSelect").value,
            host: document.getElementById("host").value,
            username: document.getElementById("username").value,
            password: document.getElementById("password").value,
            interface: document.getElementById("interfaceSelect").value
        };
    }

    async function compareAttrs() {
        const payload = buildPortPayload();
        const resp = await fetch("http://localhost:8001/interface/compare-attrs", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            cache: "no-store",
            body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (!resp.ok || json.detail) return showMessage(`Chyba: ${json.detail || "compare failed"}`, "error");

        const lines = json.rows.map(r =>
            `${r.field}: SoT=${r.sot ?? ""} | DEV=${r.device ?? ""} | ${r.match ? "OK" : "DIFF"}`
        ).join("<br>");

        const box = document.getElementById("message");
        box.innerHTML = `<strong>In sync:</strong> ${json.in_sync ? "Áno ✅" : "Nie ❌"}<br><br>${lines}`;
        box.className = json.in_sync ? "success" : "error";
        box.style.display = "block";

        function diffCount(diffLines) {
            return (diffLines || []).filter(l => (
                (l.startsWith("+") && !l.startsWith("+++")) ||
                (l.startsWith("-") && !l.startsWith("---"))
            )).length;
        }

        function renderCompareResult(res) {
            const overall = res.in_sync ? "IN SYNC ✅" : "OUT OF SYNC ⚠️";

            const state = res.state || {};
            const config = res.config || {};

            const stateLine =
                `SoT enabled: ${state.sot_enabled}\n` +
                `Device admin_up: ${state.device_admin_up}\n` +
                `Device oper_up: ${state.device_oper_up}\n` +
                `State in sync: ${state.in_sync}`;

            const cfgDiff = (config.diff || []).join("\n");
            const cfgDiffCnt = diffCount(config.diff || []);

            return (
                `Device: ${res.device}  Platform: ${res.platform}\n` +
                `Interface: ${res.interface}\n` +
                `Status: ${overall}\n\n` +

                `=== STAV (TextFSM) ===\n` +
                `${stateLine}\n\n` +

                `=== CONFIG DIFF (rozdyly: ${cfgDiffCnt}) ===\n` +
                `${cfgDiff || "(žiadny diff)"}`
            );
        }
    }

    async function applyReplace() {
        const payload = buildPortPayload();
        if (!confirm("REPLACE resetne port (default interface) a nastaví podľa SoT. Pokračovať?")) return;

        const resp = await fetch("http://localhost:8001/interface/apply-replace", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            cache: "no-store",
            body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (!resp.ok || json.detail) return showMessage(`Chyba: ${json.detail || "apply failed"}`, "error");

        showMessage("Hotovo ✅ Port nastavený podľa SoT.", "success");
        await compareAttrs();
    }


    /******************************************************************
     * GRAF ERROR COUNTERS (WebSocket + Chart.js)
     ******************************************************************/
    let ws = null;
    let modalChart = null;

    function initModalChart() {
        const ctx = $("modalCountersChart").getContext("2d");
        modalChart = new Chart(ctx, {
            type: "line",
            data: {
                labels: [],
                datasets: [
                    {label: "Input error packets", data: [], fill: false},
                    {label: "Output error packets", data: [], fill: false}
                ]
            },
            options: {
                responsive: true,
                scales: {
                    x: {type: "time", time: {unit: "second"}},
                    y: {beginAtZero: true}
                }
            }
        });
    }

    function openChartModal() {
        openModal("chartModal");
        if (!modalChart) initModalChart();
    }

    function closeChartModal() {
        // zatvor WS ak beží
        if (ws && ws.readyState === WebSocket.OPEN) ws.close();

        // schovaj modal
        closeModal("chartModal");

        // reset grafu
        if (modalChart) {
            modalChart.data.labels.length = 0;
            modalChart.data.datasets.forEach(ds => ds.data.length = 0);
            modalChart.update();
        }
    }

    function startOrStopErrorChart() {
        const btn = $("measureBtn");

        // Ak WS nebeží -> štart
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            const payload = buildBasePayload();
            if (!validateBase(payload)) {
                return showMessage("Vyplň všetky polia vrátane interface.", "error");
            }

            openChartModal();
            btn.textContent = "Stop meranie";
            showMessage("", "info");

            const url = `${WS_HOST()}/ws/counters`
                + `?host=${encodeURIComponent(payload.host)}`
                + `&username=${encodeURIComponent(payload.username)}`
                + `&password=${encodeURIComponent(payload.password)}`
                + `&interface=${encodeURIComponent(payload.interface)}`;

            ws = new WebSocket(url);

            ws.onmessage = (ev) => {
                const msg = JSON.parse(ev.data);
                if (msg.error) return;

                const now = new Date();
                modalChart.data.labels.push(now);
                modalChart.data.datasets[0].data.push(msg.input);
                modalChart.data.datasets[1].data.push(msg.output);
                modalChart.update();
            };

            ws.onclose = () => {
                btn.textContent = "Štart error graf";
            };

            return;
        }

        // Ak WS beží -> stop
        ws.close();
        btn.textContent = "Štart error graf";
    }

    /******************************************************************
     * LIVE COUNTERS (WebSocket + text)
     ******************************************************************/
    let liveWs = null;

    function startLiveCounters() {
        const payload = buildBasePayload();
        if (!validateBase(payload)) {
            return showMessage("Vyplň všetky polia vrátane interface.", "error");
        }

        $("liveCounter").style.display = "block";

        const url = `${WS_HOST()}/ws/live-counters`
            + `?host=${encodeURIComponent(payload.host)}`
            + `&username=${encodeURIComponent(payload.username)}`
            + `&password=${encodeURIComponent(payload.password)}`
            + `&interface=${encodeURIComponent(payload.interface)}`;

        liveWs = new WebSocket(url);

        liveWs.onopen = () => showMessage("Live counter spustený…", "info");
        liveWs.onmessage = (ev) => {
            const msg = JSON.parse(ev.data);
            if (msg.error) {
                showMessage(`Chyba: ${msg.error}`, "error");
            } else {
                $("liveInput").innerText = msg.input;
                $("liveOutput").innerText = msg.output;
            }
        };
        liveWs.onerror = () => showMessage("Chyba Live WS", "error");
        liveWs.onclose = () => showMessage("Live counter zastavený.", "info");
    }

    function stopLiveCounters() {
        if (liveWs && liveWs.readyState === WebSocket.OPEN) liveWs.close();
        $("liveCounter").style.display = "none";
    }

    /******************************************************************
     * INIT + EVENT LISTENERS
     ******************************************************************/
    async function init() {
        try {
            showMessage("Načítavam regióny…", "info");
            const regions = await fetchRegions();
            clearSelect("regionSelect");
            fillSelect("regionSelect", regions, "name", "id");
            showMessage("", "info");
        } catch (e) {
            showMessage(`Nastala chyba pri init: ${e.message}`, "error");
        }
    }

    async function applyMerge() {
        const payload = buildPortPayload();
        if (!confirm("MERGE doplní/nastaví to, čo je v SoT (bez resetu portu). Pokračovať?")) return;

        const resp = await fetch("http://localhost:8001/interface/apply-merge", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            cache: "no-store",
            body: JSON.stringify(payload)
        });
        const json = await resp.json();
        if (!resp.ok || json.detail) return showMessage(`Chyba: ${json.detail || "apply failed"}`, "error");

        showMessage("Hotovo ✅ MERGE aplikovaný.", "success");
        // zobraz, čo reálne poslal backend a čo vrátilo zariadenie
        const text =
            `APPLIED MERGE ✅\n\n` +
            `Commands:\n${(json.commands || []).join("\n")}\n\n` +
            `Device output:\n${json.output || ""}`;

        $("diffSummary").style.display = "block";
        $("diffSummary").textContent = text;
    }


    // Select onchange
    $("regionSelect").addEventListener("change", onRegionChange);
    $("subregionSelect").addEventListener("change", onSubregionChange);
    $("siteSelect").addEventListener("change", onSiteChange);
    $("deviceSelect").addEventListener("change", onDeviceChange);
    $("clearMacBtn").addEventListener("click", clearMacTableUI);
    $("compareConfigBtn").addEventListener("click", compareConfigUI);
    $("diffApplyMergeBtn").addEventListener("click", applyMerge);
    $("diffApplyReplaceBtn").addEventListener("click", applyReplace);


    // Akčné tlačidlá (data-action)
    document.querySelectorAll("button[data-action]").forEach(btn => {
        btn.addEventListener("click", () => sendRequest(btn.dataset.action));
    });

    // Modaly: close
    $("closeChartModal").addEventListener("click", closeChartModal);
    $("stopModalBtn").addEventListener("click", () => {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.close();
            $("measureBtn").textContent = "Štart error graf";
            showMessage("Meranie zastavené. Graf zostáva otvorený.", "info");
        }
    });

    $("closeDiffModal").addEventListener("click", () => closeModal("diffModal"));

    // Graf a live
    function validateBase(payload) {
        return payload.device_name && payload.host && payload.interface;
    }

    $("measureBtn").addEventListener("click", startOrStopErrorChart);
    $("liveBtn").addEventListener("click", startLiveCounters);
    $("stopLiveBtn").addEventListener("click", stopLiveCounters);

    // Štart aplikácie
    init();
</script>
</body>
</html>
